- name: Configure Sensu client
  sensu_client:
    name: "{{ inventory_hostname }}"
    address: "{{ public_address | default(ansible_default_ipv4.address) }}"
    subscriptions: "{{ rdo_subscriptions | default(['default']) }}"
    socket:
      bind: "127.0.0.1"
      port: "3030"
    keepalive:
      thresholds:
        warning: 180
        critical: 360
      handlers:
        - "errbot"
      custom:
        broadcast:
          - "#rdo-dev"
      occurrences: 3
      retry_occurrences: 30
  notify:
    - Restart sensu-client

- name: Install base packages
  package:
    name: "{{ rdo_sensu_client_packages }}"
    state: "latest"

# https://github.com/sensu-plugins/sensu-plugins-memory-checks/issues/33
- name: Install vmstat gem for check memory
  gem:
    executable: "/opt/sensu/embedded/bin/gem"
    name: "vmstat"
    state: "present"

- name: Install required Sensu plugins
  command: sensu-install -P {{ item.key }}
  args:
    creates: "{{ item.value.creates }}"
  with_dict: "{{ rdo_sensu_plugins }}"

- name: Setup custom Sensu plugins
  copy:
    src: "{{ item }}"
    dest: "/opt/sensu/embedded/bin/{{item}}"
    mode: "0755"
    owner: "sensu"
    group: "sensu"
  with_items: "{{ rdo_custom_sensu_plugins }}"

- name: Ensure Sensu handlers directory exists
  file:
    path: "/etc/sensu/handlers"
    state: "directory"

- name: Setup custom Sensu handlers
  copy:
    src: "{{ item }}"
    dest: "/etc/sensu/handlers/{{ item }}"
    mode: "0755"
    owner: "sensu"
    group: "sensu"
  with_items: "{{ rdo_custom_sensu_handlers }}"

- name: Setup custom Sensu extensions
  copy:
    src: "{{ item }}"
    dest: "/etc/sensu/extensions/{{ item }}"
    mode: "0755"
    owner: "sensu"
    group: "sensu"
  with_items: "{{ rdo_custom_sensu_extensions }}"
