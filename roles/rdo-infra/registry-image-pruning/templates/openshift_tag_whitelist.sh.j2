#!/bin/bash
# Generates a comma separated value of tags to whitelist for the RDO registry.
# We want to whitelist some tag names (ex: "current-tripleo") but also the hash
# that they resolve to (ex: "5466f249bd36900a1dac573cdc83e7a11493aea2_0c8f7f95")

# TODO: Rely on the container image metadata instead.

releases="{{ pruner_dlrn_endpoints | join(' ') }}"
names="{{ pruner_extended_whitelist | join(' ') }}"
architectures="{{ pruner_architectures | join(' ') }}"

[[ ! -d /tmp/dlrnapi ]] && virtualenv /tmp/dlrnapi >/dev/null
source /tmp/dlrnapi/bin/activate
pip install setuptools --upgrade >/dev/null
pip install dlrnapi_client >/dev/null

(for release in $releases
do
  for name in $names
  do
     # Whitelist named tag (ex: current-tripleo)
     echo $name
     # Whitelist the resolved DLRN hash from the named tag (ex: f31e00b220162890eac1de06ba1d1f89e4ec9d44_bbaf1d8e)
     repo_hash=$(dlrnapi --url https://trunk.rdoproject.org/${release} promotion-get --promote-name ${name} --limit 1 | jq -r '.[0] | (.repo_hash)')
     echo $repo_hash
     for arch in $architectures
     do
        # Include architecture suffixes in the whitelist (ex: f31e00b220162890eac1de06ba1d1f89e4ec9d44_bbaf1d8e_x86_64)
        echo "${repo_hash}_${arch}"
     done
  done
done) | sort | uniq |paste -sd ','
