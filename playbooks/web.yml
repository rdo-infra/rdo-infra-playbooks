---

# topics to consider (from Duck):
# - use of OSCI services for hosts hosted in the Community Cage (currently only rdo-web-builder.osci.io)
#   + chrony should be configured to use OSCI servers
#   + resolv.conf should be configured to use OSCI servers
#   -> OSAS is thinking on how to share these configuration parameters to keep them in sync, WIP
# - OSAS rules use EPEL unconditionally
#   also roles do not make use of 'enablerepo: epel'
#   maybe the RDO base could enable/disable epel on a per-host basis (currently it disables unconditionally)
# - OSAS adds its own Copr repository (this should not be necessary anymore in this case when needrestart enters a CentOS/Fedora release, but could take some time until the servers are upgraded to this release)
# - missing common features compared to OSAS playbook:
#   + yum-cron support (unattended_updates role)
#   + needrestart support (base role): we could make it a role to share easily
#   + qemu-guest-agent when needed (guest_virt_tools role) (affects rdo-web-builder.osci.io)
#   + selinux config is partial (selinux role)
#   + firewalld (base role): many roles expect it to be installed
# - rdo_download_stats and rdo_redirect_repos were initially inside the old OSAS repo, reworked and still kept inside in the new repo
#   we should think about having them in their own repo, or reorganizing the rules; I'm leaving this as-is until discussed


- hosts: rdo-web-builder.osci.io
  vars:
    website_username: web_builder
    # temporarily here until we find a better place (see "use of OSCI services" above)
    mail_forwarder: mx1.osci.io
  roles:
  - role: builder
    name: "{{ website_name }}"
    builder: "{{ website_builder | default('middleman') }}"
    builder_username: "{{ website_username }}"
    git_url: "{{ website_repo_url }}"
    git_version: master
    auto_deploy_hour: "*/6"
    cron_error_email: "{{ builder_error_email }}"
  - role: msmtp
    smart_host: "{{ mail_forwarder }}"
    disable_freeipa: true
  tasks:
  - name: fetch dashboard
    cron:
      name: "fetch dashboard"
      minute: "0"
      hour: "*/6"
      user: "{{ website_username }}"
      job: "cd /srv/builder/{{ website_name }} && ./fetch-dashboard.rb"
    when: website_has_dashboard is defined and website_has_dashboard

- hosts: www.rdoproject.org
  vars:
    use_ssl: True
    force_ssl: True
    use_letsencrypt: True
  tasks:
    - name: create web builder's user
      user:
        name: "{{ websync_user }}"
        comment: "Web Builder User"
    - name: Create vhost for www.rdoproject.org
      include_role:
        name: httpd
        tasks_from: vhost
      vars:
        website_domain: www.rdoproject.org
        document_root: "{{ websync_path }}"
        document_root_group: "{{ websync_user }}"
        server_aliases:
          - rdoproject.org
          - openstack.redhat.com
        use_mod_speling: True
    - name: "Add RDO-specific mod_speling config"
      copy:
        content: "CheckCaseOnly on\n"
        dest: /etc/httpd/conf.d/www.rdoproject.org.conf.d/mod_speling_rdo.conf
      notify: reload httpd
    - name: Install web redirection to RDO Repositories
      include_role:
        name: rdo_redirect_repos
    - name: Create vhost for ask.rdoproject.org
      include_role:
        name: httpd
        tasks_from: vhost
      vars:
        website_domain: ask.rdoproject.org
        redirect: https://ask.openstack.org/en/questions/scope:unanswered/sort:age-desc/page:1/query:rdo/
    - name: Create vhost for docs.rdoproject.org
      include_role:
        name: httpd
        tasks_from: vhost
      vars:
        website_domain: docs.rdoproject.org
        redirect: https://www.rdoproject.org/documentation/
    - name: Install RDO Dashboards
      include_role:
        name: rdo_dashboards
      vars:
        website_domain: dashboards.rdoproject.org
    - name: Generate RDO download stats
      include_role:
        name: rdo_download_stats

